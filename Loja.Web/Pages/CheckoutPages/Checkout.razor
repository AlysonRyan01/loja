@page "/checkout/{Slug}"
@using System.ComponentModel.DataAnnotations
@using Loja.Core.Models
@inherits CheckoutPage


@inject NavigationManager Navigation

@if (IsBusy)
{
    <MudProgressCircular Color="Color.Info" Indeterminate="true" />
}
else
{
    <div class="div-principal-checkout">
        <div class="div-userinfo-endereco-pagamento">
            <section class="section-userinfo">
                <h2 class="h2-userinfo">Informações pessoais</h2>
                <MudForm Model="UserInfo" @ref="UserInfoForm">
                    <MudTextField Margin="Margin.Dense" Variant="Variant.Outlined" Label="Nome" @bind-Value="UserInfo.FullName" FullWidth Required="true"
                                  RequiredError="O nome é obrigatório" />

                    <MudTextField Margin="Margin.Dense" Variant="Variant.Outlined" Label="Email" @bind-Value="UserInfo.Email" FullWidth
                                  Validation="@(new EmailAddressAttribute().IsValid)" />

                    <MudTextField Margin="Margin.Dense" Variant="Variant.Outlined" Label="Telefone"
                                  FullWidth
                                  Validation="ValidatePhone"
                                  Mask="@(new PatternMask("(00) 00000-0000"))" @bind-Value="UserInfo.PhoneNumber"/>

                    <MudButton OnClick="UserInfoValidation" Disabled="@UserInfoIsValid" Color="Color.Primary">Validar</MudButton>
                </MudForm>
            </section>
            @if (UserInfoIsValid)
            {
                <section class="section-endereco" @ref="EnderecoSection">
                    <h2 class="h2-userinfo">Endereço de entrega</h2>
                    <MudForm Model="Endereco" @ref="UserAdressForm">
                        <div style="display: flex; width: 100%">
                            <MudTextField Style="margin-right: 10px;"
                                Margin="Margin.Dense"
                                Variant="Variant.Outlined"
                                Label="Rua"
                                @bind-Value="Endereco.Rua"
                                FullWidth
                                Required="true"
                                RequiredError="O campo Rua é obrigatório" />

                            <MudTextField
                                Style="width: 90px;"
                                Margin="Margin.Dense"
                                Variant="Variant.Outlined"
                                Label="Número"
                                @bind-Value="Endereco.Numero"
                                Required="true"
                                RequiredError="O campo Número é obrigatório" />
                        </div>

                        <MudTextField
                            Margin="Margin.Dense"
                            Variant="Variant.Outlined"
                            Label="Bairro"
                            @bind-Value="Endereco.Bairro"
                            FullWidth
                            Required="true"
                            RequiredError="O campo Bairro é obrigatório" />

                        <MudTextField
                            Margin="Margin.Dense"
                            Variant="Variant.Outlined"
                            Label="Cidade"
                            @bind-Value="Endereco.Cidade"
                            FullWidth
                            Required="true"
                            RequiredError="O campo Cidade é obrigatório" />

                        <MudTextField
                            Margin="Margin.Dense"
                            Variant="Variant.Outlined"
                            Label="Estado"
                            @bind-Value="Endereco.Estado"
                            FullWidth
                            Required="true"
                            RequiredError="O campo Estado é obrigatório" />

                        <MudTextField
                            Style="width: 200px;"
                            Margin="Margin.Dense"
                            Variant="Variant.Outlined"
                            Label="CEP"
                            @bind-Value="Endereco.CEP"
                            FullWidth
                            Required="true"
                            Mask="@(new PatternMask("00000-000"))"
                            RequiredError="O campo CEP é obrigatório"
                            Validation="ValidateCEP"/>

                        <MudButton OnClick="UserAdressValidation" Disabled="@UserAddressIsValid" Color="Color.Primary">Validar</MudButton>
                    </MudForm>
                </section>
            }
            @if (UserInfoIsValid && UserAddressIsValid)
            {
                <section class="section-pagamento" @ref="PagamentoSection">
                    <h2 class="h2-userinfo">Pagamento</h2>
                    <p style="font-size: 1.2rem">Valor total: @carrinho.ValorTotal.ToString("C")</p>
                    <MudTextField Label="Nome no Cartão" @bind-Value="Cartao.Nome" FullWidth />
                    <MudTextField Mask="@(new PatternMask("000.000.000-00"))" Label="CPF" @bind-Value="Cartao.CPF" FullWidth />
                    <MudTextField Mask="@(new PatternMask("0000 0000 0000 0000"))" Label="Número do Cartão" @bind-Value="Cartao.Numero" FullWidth />
                    <div style="display: flex; width: 100%">
                        <MudTextField Mask="@(new DateMask("MM/YY", 'Y', 'M'))" Style="width: 50%" Label="Data de Expiração" @bind-Value="Cartao.Expiracao" />
                        <MudTextField Mask="@(new PatternMask("000"))" Style="width: 50%" Label="CVV" @bind-Value="Cartao.CVV" />
                    </div>
                </section>
            }
        </div>

        <div class="div-produtoinfo">
            <h2 class="h2-produtos-checkout">Produtos:  <span style="font-weight: lighter; font-size: 1.2rem; color: gray;">@carrinho.CarrinhoItens.Count</span></h2>
            @if (Slug.StartsWith("carrinho-"))
            {
                foreach (var item in carrinho.CarrinhoItens)
                {
                    <section class="section-produtos-carrinho">
                        @if (item.Produto.Imagens?.FirstOrDefault() is { } primeiraImagem)
                        {
                            var imagemUrl = $"{WebConfiguration.BackendUrl}{primeiraImagem.Url}";
                            <img class="img-produto-checkout" src="@imagemUrl" alt="Imagem do produto"/>
                        }
                        <p class="titulo-produto-checkout">@item.Produto.Titulo</p>
                        <p class="preco-produto-checkout">@item.Produto.Preco.ToString("C")</p>
                    </section>
                }
            }
            else if ((Slug.StartsWith("produto-")))
            {
                
            }
        </div>
    </div>
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="div-para-esconder">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge">
            <MudGrid>
                <!-- Coluna Principal (70% da tela) -->
                <MudItem xs="12" md="9">
                    <MudPaper Class="p-4">
                        <MudGrid Spacing="3">
                            <!-- Informações do Usuário -->
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardContent>
                                        <MudTypography Variant="h6">Informações do Usuário</MudTypography>
                                        <MudTextField Label="Nome" @bind-Value="UserInfo.Name" FullWidth />
                                        <MudTextField Label="Email" @bind-Value="UserInfo.Email" FullWidth />
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>

                            <!-- Endereço do Pedido -->
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardContent>
                                        <MudTypography Variant="h6">Endereço de Entrega</MudTypography>
                                        <MudTextField Label="Rua" @bind-Value="Endereco.Rua" FullWidth />
                                        <MudTextField Label="Número" @bind-Value="Endereco.Numero" FullWidth />
                                        <MudTextField Label="Cidade" @bind-Value="Endereco.Cidade" FullWidth />
                                        <MudTextField Label="Estado" @bind-Value="Endereco.Estado" FullWidth />
                                        <MudTextField Label="CEP" @bind-Value="Endereco.CEP" FullWidth />
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>

                            <!-- Informações do Cartão de Crédito -->
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardContent>
                                        <MudTypography Variant="h6">Pagamento</MudTypography>
                                        <MudTextField Label="Número do Cartão" @bind-Value="Cartao.Numero" FullWidth />
                                        <MudTextField Label="Nome no Cartão" @bind-Value="Cartao.Nome" FullWidth />
                                        <MudTextField Label="Data de Expiração" @bind-Value="Cartao.Expiracao" FullWidth />
                                        <MudTextField Label="CVV" @bind-Value="Cartao.CVV" FullWidth />
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>

                <!-- Coluna Lateral (30% da tela) - Produtos no Carrinho -->
                @if (Slug.StartsWith("carrinho-"))
                {
                    <MudItem xs="12" md="3">
                        <MudPaper Class="p-4">
                            <MudTypography Variant="h6">Resumo do Pedido</MudTypography>
                            <MudList T="CarrinhoItem">
                                @foreach (var item in carrinho.CarrinhoItens)
                                {
                                    <MudListItem T="string">
                                        <MudListItemText>
                                            <MudTypography>@item.Produto.Titulo</MudTypography>
                                            <MudTypography Color="Color.Secondary">Quantidade: @item.Quantidade</MudTypography>
                                            <MudTypography Color="Color.Primary">Preço: @item.Produto.Preco.ToString("C")</MudTypography>
                                        </MudListItemText>
                                    </MudListItem>
                                }
                            </MudList>
                            <MudDivider />
                            <MudTypography Variant="h6">Total: @Total.ToString("C")</MudTypography>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth>Finalizar Compra</MudButton>
                        </MudPaper>
                    </MudItem>
                }
                else if (Slug.StartsWith("produto-"))
                {
                    <MudItem xs="12" md="3">
                        <MudPaper Class="p-4">
                            <MudTypography Variant="h6">Resumo do Pedido</MudTypography>
                            <MudCard>
                                <MudCardContent>
                                    <MudTypography Variant="h6">@produto.Titulo</MudTypography>
                                    <MudTypography Color="Color.Secondary">Quantidade: 1</MudTypography>
                                    <MudTypography Color="Color.Primary">Preço: @produto.Preco.ToString("C")</MudTypography>
                                </MudCardContent>
                            </MudCard>
                            <MudDivider />
                            <MudTypography Variant="h6">Total: @Total.ToString("C")</MudTypography>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth>Finalizar Compra</MudButton>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        </MudContainer>
    </div>

}